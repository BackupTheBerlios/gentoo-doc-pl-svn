?xml version='1.0' encoding='UTF-8'?>
<!-- $Header: /cvsroot/gentoo-doc-pl/trans/translated/ldap-howto.xml,v 1.4 2005/05/05 23:45:02 rane Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- Orig revision: 1.17 -->
<!-- Translator: ShadoWW <damian@lezajsk.info> -->
<!-- Title: Praca z LDAP -->
<!-- Status: Ukończono -->

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/license/by-sa/1.0 -->

<guide link="/doc/en/ldap-howto.xml">
<title>Przewodnik Gentoo po autoryzacji OpenLDAP.</title>

<author title="Author">
  <mail link="sj7trunks@gentoo.org">Benjamin Coles</mail>
</author>

<author title="Editor">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>

<author title="Editor">
  <mail link="tseng@gentoo.org">Brandon Hale</mail>
</author>
<author title="Editor">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>


<abstract>
Ten przewodnik przedstawia podstawy LDAP i pokazuje w jaki sposób skonfigurować
OpenLDAP w celu autoryzacji w grupach komputerów z Gentoo.
</abstract>

<license/>

<version>0.11</version>
<date>2005-01-22</date>

<chapter>
<title>Wprowadzenie do OpenLDAP.</title>
<section>
<title>Co to jest LDAP?</title>
<body>

<p>
Pod pojęciem LDAP kryje się <e>lekki protokół dostępu do katalogów</e>. Jest
oparty na X.500 i zawiera w sobie większość jego podstawowych funkcji, a jest
pozbawiony jego funkcji zaawansowanych. Co to jest X.500?
</p>

<p>
X.500 jest modelem usług katalogowych w ujęciu OSI. Zawiera
definicje przestrzeni nazw i protokołów zapytań oraz aktualizacji
katalogów. Zwykle jest jednak zbyt rozbudowanym rozwiązaniem.
LDAP, tak jak X.500, zawiera model danych i przestrzeni nazw dla
katalogu oraz dla protokołu. Został tak zaprojektowany, aby działać
bezprośrednio nad stosem TCP/IP. Można go postrzegać jako uproszczoną wersję
X.500.
</p>

</body>
</section>

<section>
<title>Nie rozumiem. Co to jest katalog?</title>
<body>

<p>
Katalog jest wyspecjalizowaną bazą danych zaprojektowaną dla dużej ilości
zapytań i małej ilości aktualizacji. W przeciwieństwie do zwykłych baz danych
nie zawierają wsparcia dla transakcji odwrotnych. Katalogi można łatwo kopiować
w celu podwyższenia dostępności i niezawodności. Kiedy są kopiowane może
dochodzić do pewnych niezgodności, trawających tak długo, jak długo będą
synchronizowały. 
</p>

</body>
</section>

<section>
<title>W jaki sposób rozmieszczono informacje?</title>
<body>

<p>
Wszystkie informacje wewnątrz katalogu rozmieszczone są według określonej
hierarchii. Co więcej, jeśli użytkownik zechce odczytać dane wewnątrz katalogu,
katalog musi wiedzieć w jaki sposób zgromadzić dane wewnątrz drzewa. Przyjrzyjmy
się fikcyjnej firmie i jej sieciowemu drzewu:
</p>

<pre caption = "Struktura organizacji dla GenFic, fikcyjnej firmy Gentoo.">
dc:         com
             |
dc:        genfic         <comment>(Organizacja)</comment>
          /      \
ou:   ludzie   serwery    <comment>(Jednostki Organizacji)</comment>
      /    \     ..     
uid: ..   jhon            <comment>(OU-specyficzne dane)</comment>
</pre>

<p>
W związku z tym, że dane do bazy nie są wprowadzane kolejno jak na powyższym
grafie każda jej część musi posiadać określoną nazwę. Większość dystrubucji LDAP
(wliczając w to OpenLDAP) posiada już sporą ilość zdefiniowanych (i ogólnie
przyjętych) schematów, takich jak inetorgperson, powszechnie używany schemat
definiowania użytkowników.
</p>

<p>
Zainteresowanym użytkownikom polecam przeczytanie dokumentu <uri
link="http://www.openldap.org/doc/admin21/">OpenLDAP Admin Guide</uri>.
</p>

</body>
</section>

</chapter>


<chapter>
<title>Konfiguracja OpenLDAP.</title>
<section>
<title>Konfiguracja wstępna.</title>
<body>

<note>
W tym dokumencje będziemy używać przykładowego adresu genfic.com. Oczywiście w
każdym przypadku użytkownik musi zmienić ten adres na swój własny. Należy się
upewnić, czy najwyższy węzeł jest oficjalną domeną wysokiego poziomu (net, com,
cc, be, ...).
</note>

<p>
Zaczynamy od zemergowania wszystkich potrzebnych komponentów na nasz serwer:
</p>

<pre caption="Instalacja OpenLDAP">
# <i>emerge openldap pam_ldap nss_ldap migrationtools</i>
 
# <i>chown ldap:ldap /var/lib/openldap-ldbm /var/lib/openldap-data /var/lib/openldap-slurp</i>
</pre>

<p>
Następnie edytujemy plik <path>/etc/openldap/slapd.conf</path> dodając
następujące linijki po <c>core.schema</c>:
</p>

<pre caption="/etc/openldap/slapd.conf">
<comment># Uwzględnienie potrzebnych schematów.</comment>
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema

<comment># Użycie funkcji crypt, aby ukryć hasło.</comment>
password-hash {crypt}

<comment># Zdefiniowanie właściwości SSL i TLS (opcja).</comment>
TLSCertificateFile /etc/ssl/ldap.pem
TLSCertificateKeyFile /etc/openldap/ssl/ldap.pem
TLSCACertificateFile /etc/ssl/ldap.pem

<codenote>W następnej kolejności...</codenote>

database        ldbm
suffix          "dc=genfic,dc=com"
rootdn          "cn=Manager,dc=genfic,dc=com"
rootpw          <i>{MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==</i>
directory       /var/lib/openldap-ldbm
index           objectClass     eq

<codenote>Niezaszyfrowane hasła tworzy się przy pomocy polecenia slappasswd -h {Md5}</codenote>
</pre>

<p>
Następnie edytujemy plik konfiguracyjny LDAP:
</p>

<pre caption="/etc/openldap/ldap.conf">
# <i>nano -w /etc/openldap/ldap.conf</i>
<codenote>Dodając następujące linijki...</codenote>

BASE         dc=genfic, dc=com
URI          ldaps://auth.genfic.com:636/
TLS_REQCERT  allow
</pre>

<p>
Następnie, aby zabezpieczyć katalog trzeba wygenerować certyfikat SSL.
Proces ten to seria odpowiedzi na kolejno zadawane pytania. Kiedy zostaniemy
zapytani o <e>Common Name</e> wpisujemy nazwę za pomocą której klienci będą
mogli łączyć się z serwerem. Z reguły będzie to pełna nazwa domeny (np.
<path>auth.genfic.com</path>).
</p>

<pre caption="Generowanie certyfikatu SSL">
# <i>cd /etc/ssl</i>
# <i>openssl req -config /etc/ssl/openssl.cnf -new -x509 -nodes -out \
ldap.pem -keyout /etc/openldap/ssl/ldap.pem -days 999999</i>
</pre>

<p>
Edytujemy plik <path>/etc/conf.d/slapd</path> i dodajemy następującą linijkę,
maskując obecną:
</p>

<pre caption="/etc/conf.d/slapd">
OPTS="-h 'ldaps:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'"
</pre>

<p>
Uruchomienie slapd:
</p>

<pre caption = "Uruchamianie SLAPd.">
# <i>/etc/init.d/slapd start</i>
</pre>

<p>
Możemy przetestować program używając polecenia:
</p>

<pre caption = "Przetestuj demona SLAPd.">
# <i>ldapsearch -D "cn=Manager,dc=genfic,dc=com" -W</i>
</pre>

<p>
Jeśli otrzymamy błąd, należy uruchomić usługę dodając parametr <c>-d 255</c>.
Spowoduje to dokładniejsze opisanie błędu i znacznie pomoże w rozwiązaniu
zaistniałego problemu.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Eksportowanie istniejących danych.</title>
<section>
<title>Eksportowanie kont użytkowników.</title>
<body>

<p>
Pora na wyeksportowanie kont użytkowników. Otwieramy plik 
<path>/usr/share/migrationtools/migrate_common.ph</path> i edytujemy go w
następujący sposób:
</p>

<pre caption="/usr/share/migrationtools/migrate_common.ph">
$DEFAULT_BASE = "dc=genfic,dc=com";
$EXTENDED_SCHEMA = 1;
<comment># Zakomentuj poniższe linie, chyba że posiadasz załadowany schemat
pocztowy.</comment>
<comment>#$DEFAULT_MAIL_DOMAIN = "genfic.com";</comment>
<comment>#$DEFAULT_MAIL_HOST = "mail.genfic.com";</comment>
</pre>

<p>
Teraz czas na uruchomienie skryptów eksportujących:
</p>

<pre caption="Uruchamianie skryptów eksportujących.">
# <i>export ETC_SHADOW=/etc/shadow</i>
# <i>cd /usr/share/migrationtools</i>
# <i>./migrate_base.pl > /tmp/base.ldif</i>
# <i>./migrate_group.pl /etc/group /tmp/group.ldif</i>
# <i>./migrate_hosts.pl /etc/hosts /tmp/hosts.ldif</i>
# <i>./migrate_passwd.pl /etc/passwd /tmp/passwd.ldif</i>
</pre>

<p>
W tym kroku wyeksportowaliśmy pliki do formatu ldif czytanego przez LDAP.
Teraz dodajemy te pliki do naszego katalogu:
</p>

<pre caption="Import danych do naszego katalogu.">
# <i>ldapadd -D "cn=Manager,dc=genfic,dc=com" -W -f /tmp/base.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=genfic,dc=com" -W -f /tmp/group.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=genfic,dc=com" -W -f /tmp/passwd.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=genfic,dc=com" -W -f /tmp/hosts.ldif</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Konfigurowanie uwierzytelniania.</title>
<section>
<title>Konfigurowanie PAM.</title>
<body>

<p>
Następnie należy skonfigurować PAM tak, aby zezwalała na autoryzację LDAP.
W tym celu edytujemy <path>/etc/pam.d/system-auth</path> tak, aby wyglądał jak
poniżej:
</p>

<pre caption="/etc/pam.d/system-auth">
auth    required    /lib/security/pam_env.so
auth    sufficient  /lib/security/pam_unix.so likeauth nullok shadow
auth    sufficient  /lib/security/pam_ldap.so use_first_pass
auth    required    /lib/security/pam_deny.so

account sufficient  /lib/security/pam_unix.so
account sufficient  /lib/security/pam_ldap.so
account required    /lib/security/pam_deny.so

password    required /lib/security/pam_cracklib.so retry=3
password    sufficient /lib/security/pam_unix.so nullok use_authtok shadow md5
password    sufficient /lib/security/pam_ldap.so use_authtok
password    required /lib/security/pam_deny.so

session required    /lib/security/pam_limits.so
session required    /lib/security/pam_unix.so
session required     /lib/security/pam_mkhomedir.so skel=/etc/skel/ umask=0
session optional    /lib/security/pam_ldap.so
</pre>

<p>
Plik <path>/etc/ldap.conf</path> edytujemy do odczytu:
</p>

<pre caption="/etc/ldap.conf">
<comment>#host 127.0.0.1</comment>
<comment>#base dc=padl,dc=com</comment>

ssl start_tls
ssl on
suffix          "dc=genfic,dc=com"
<comment>#rootbinddn uid=root,ou=People,dc=genfic,dc=com</comment>

uri ldaps://auth.genfic.com/
pam_password exop

ldap_version 3
pam_filter objectclass=posixAccount
pam_login_attribute uid
pam_member_attribute memberuid
nss_base_passwd ou=People,dc=genfic,dc=com
nss_base_shadow ou=People,dc=genfic,dc=com
nss_base_group  ou=Group,dc=genfic,dc=com
nss_base_hosts  ou=Hosts,dc=genfic,dc=com

scope one
</pre>

<p>
Na koniec konfigurujemy swoich klientów tak, aby sprawdzały LDAP dla kont
systemowych:
</p>

<pre caption="/etc/nsswitch.conf">
passwd:         files ldap
group:          files ldap
shadow:         files ldap
</pre>

<p>
Aby przetestować zmiany należy wpisać:
</p>

<pre caption="Testowanie autoryzacji LDAP:">
# <i>getent passwd|grep 0:0</i>

<codenote>Powinnieneś otrzymać w wyniku tego polecenia dwie linijki:</codenote>
root:x:0:0:root:/root:/bin/bash 
root:x:0:0:root:/root:/bin/bash
</pre>

<p>
Jedna z linijek, które dodaliśmy do <path>/etc/ldap.conf</path> została
zakomentowana (linia <c>rootbinddn</c>). Nie będziemy jej potrzebować, dopóki
nie zechcemy zmienić hasła roota lub zwykłego użytkownika. W takim wypadku
będziemy zmuszeni umieścić to hasło w pliku <path>/etc/ldap.secret</path>, w
dodatku otwartym tekstem. Jest to <brite>NIEBEZPIECZNE</brite> i dlatego plik
ten MUSI mieć prawa dostępu o wartości 600. Ja na codzień mam ten plik pusty, a
kiedy zachodzi potrzeba zmiany użytkownikowi hasła robię to zarówno w ldap jak i
w pliku <path>/etc/passwd</path>. Zapisuje tam hasło na 10 sekund na czas kiedy
dokonuję zmian i zaraz po ich wprowadzeniu usuwam.
</p>

</body>
</section>

<section>
<title>Zezwolenia OpenLDAP.</title>
<body>

<p>
Jeśli przyjrzymy się plikowi <path>/etc/openldap/slapd.conf</path> zauważymy, że
służy on do precyzowania ACL-i (zezwoleń) dotyczących odczytu i zapisu
danych przez użytkowników:
</p>

<pre caption="/etc/openldap/slapd.conf">
access to *
  by dn="uid=root,ou=people,dc=genfic,dc=com" write
  by users read
  by anonymous auth

access to attrs=userPassword,gecos,description,loginShell
  by self write
</pre>

<p>
Dzięki temu uzyskamy dostęp do wszystkiego do czego użytkownik powinien
mieć prawo. Jeśli będzie to jego informacja, to będzie miał prawo do jej
zapisu. Natomiast jeśli będą to informacje innego uzytkownika będzie miał prawo
wyłącznie do ich odczytu. Anonimowi użytkownicy mogą wysłać login i hasło tak,
aby się zalogować. Są cztery poziomy dostępu, od najniższego do najwyższego:
<c>auth, wyszukiwanie (search), odczyt (read) oraz zapis(write)</c>.
</p>

<p>
Następny ACL jest znacznie bezpieczniejszy, ponieważ blokuje normalnym
użytkownikom dostęp do ukrytych haseł innych ludzi:
</p>

<pre caption="/etc/openldap/slapd.conf">
access to attribute="userPassword"
  by dn="uid=root,ou=people,dc=genfic,dc=com" write
  by dn="uid=John,ou=People,dc=genfic,dc=com" write
  by anonymous auth
  by self write
  by * none
  
access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by * read
</pre>

<p>
Taka konfiguracja zapewnia suerużytkownikowi oraz użytkownikowi "john" dostęp do
odczytu (read), zapisu (write) oraz wyszukiwania (search) wszystkiego poniżej drzewa 
<path>dc=genfic,dc=com</path>. Pozwala również użytkownikowi na zmianę własnego
<path>userPassword</path>. W ostatecznym rozrachunku wszyscy pozostali muszą
jedynie wiedzieć, że mają możliwość wyszukiwania (tj. mają dostęp do 
filtra wyszukującego), jednak nie mogą odczytać wyników wyszukiwania. Możliwe
jest posiadanie wielu ACL-i, warto jednak w związku z kolejnością ich
przetwarzania zachować zasadę, że najwyższy stopień powinien być najbardziej
restrykcyjnym.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Praca z OpenLDAP.</title>
<section>
<title>Utrzymywanie katalogu.</title>
<body>

<p>
Teraz możemy rozpocząć korzystanie z katalogu do autoryzacji użytkowników w
takich programach jak apache, proftpd, qmail, czy samba. Możemy administrować
nim przy uzyciu Webmina, który posiada bardzo przejrzysty i ergonomiczny
interfejs. Możemy również korzystać z gq lub directory_administrator. 
</p>

</body>
</section>
</chapter>

<chapter>
<title>Podziękowania.</title>
<section>
<body>

<p>
Chcieliśmy podziękować Mattowi Helerowi za użyczenie nam swojej skrzynki na cele
tego przewodnika. Podziękowania należą się również ludziom z kanału #ldap
w sieci freenode (irc.freenode.net).
</p>

</body>
</section>

</chapter>
</guide>
