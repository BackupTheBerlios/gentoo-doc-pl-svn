<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/www/www.gentoo.org/raw_cvs/gentoo/xml/htdocs/doc/en/uml.xml,v 1.22 2005/02/05 16:52:57 swift Exp $ -->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<guide link="/doc/en/uml.xml">
<title>Poradnik prezentuje jak testować środowisko z jądrem w trybie użytkownika</title>
<author title="Editor">
  <mail link="g2boojum@gentoo.org">Grant Goodyear</mail>
</author>
<author title="Editor"><!-- zhen@gentoo.org -->
  John Davis
</author>
<author title="Editor">
    <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Editor">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>

<abstract>
Poradnik prezentuje jak zainstalować i testować system w celu wykrycia
potencjalnie niebezpiecznych zmian w systemie.
</abstract>

<license/>

<version>0.10</version>
<date>2005-02-05</date>

<chapter>
<title>Skąd można pobrać</title>
<section>
<body>

<p>
Ze strony www 
(<uri>http://user-mode-linux.sourceforge.net</uri>) , linuks w trybie
użytkownika
umożliwia użytkownikowi uruchomienie linuksa w samym sobie.  Dokładnie,
zapewnia wirtualną maszynę na której użytkownik może uruchamiać niestabilne
oprogramowanie, eksperymentować z nowymi jądrami, dystrybucjami, poruszać się po
wewnętrzu linuksa. To wszystko bez ryzyka dla głównego systemu. 
Eksperymenty z rdzennymi paczkami gentoo takimi jak <e>sys-apps/baselayout</e>
albo <e>sys-libs/glibc</e> mają możliwość uszkodzenia systemu i uczynienia go
niebotowalnym; które to zmiany użytkownik może testować na systemie w trybie
użytkownika bez jakich kolwiek obaw o działający system.
</p>

<p>
Instalowanie systemu w trybie użytkownika jest dokładnie indentyczne jak
normalnego.  Pierwsze jądro odpowiednio ulepszone łatami do UML i skonfigurowane
do używania UML. Od jądra 2.6.9, UML został wbudowany do czystych źródeł jądra. 
</p>

<pre caption="Installing UML kernel sources">
<comment>(Będzie przeprowadzona instalacja czystego jądra 2.6, można również
użyć źródeł "usermode")</comment>
# <i>emerge sys-kernel/development-sources</i>
# <i>cd /usr/src/linux</i>
# <i>make menuconfig <comment>ARCH=um</comment></i>
# <i>make linux <comment>ARCH=um</comment></i>
# <i>cp linux /usr/local/bin/linux</i>
</pre>

<warn>
Fragment <e>ARCH=um</e> jest <e>niezmienrnie </e> ważny!
</warn>

<p>
Należy upewnić się czy ścieżka <path>/usr/local/bin</path> jest na twojej
ścieżce. W tym celu przeprowadza się edycję
<path>/etc/env.d/00basic</path> tak aby zmienna PATH zawierała ścieżkę
<path>/usr/local/bin</path> następnie uruchamia się <c>env-update</c>:
</p>

<pre caption="Editing 00basic">
# <i>nano -w /etc/env.d/00basic</i>
# <i>env-update</i>
# <i>source /etc/profile</i>
</pre>

<p>
Aby jądro w trybie użytkownika poprawnie uruchomiło się jądro musi być tak
skonfigurowane aby <e>nie</e> montowało automatycznie 
<path>/dev</path> (devfs). Również trzeba się upewnić czy <e>tmpfs</e>
(Wirtualny system plików) jest wkompilowany, domyślnie skrypty startowe gentoo
przechowują swoje informacje w małej partycji tmpfs.
(Wersja binarna jądra jest dostępna ze strony www automatycznie montuje
<path>/dev</path>, nie posiada wkompilowanej obsługi tmpfs; nie należy
informować o tym.
</p>

<p>
Zaleca się przeczytanie dokumentacji do systemu w trybie użytkownika, ale
podstawową ideą jest uruchomienie  <path>/usr/local/bin/linux</path> program
uruchamia się w trybie użytkownika i próbuje postawić system zawarty w pliku
<path>root_fs</path>, który powinien być w katalogu w którym aktualnie pracuje
się.
</p>

<p>
Nie zaszkodzi również zainstalować narzędzi dla systemu w trybie użytkownika.
</p>

<pre caption="Installing UML tools">
# <i>emerge sys-apps/usermode-utilities</i>
</pre>

<p>
Narzędzia te ustawiają sieć (oraz pare innych rzeczy) pomiędzy wirtyalnym
systemem a systemem gospodarza.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Tworzenie root_fs</title>
<section>
<title>Tworzenie chrootowalnego gentoo</title>
<body>

<p>
Plik <path>root_fs</path> wymagany przez system w trybie użytkownika jest
pojedyńczym plikiem który zawiera w sobie cały system plików gentoo.
Aby go utworzyć będzie potrzebna obsługa urządzenia sprzężenia zwrotnego
wkompiolowana w jądro systemu gospodarza (nie w jądro systemu w trybie
użytkownika).
</p>

<p>
Tworzenie <path>root_fs</path> będzie ostatnim krokiem.  Pierwsze należy
stworzyć drzewo katalogów gentoo poprzez standardowe chrootowanie.  W tym celu
trzeba będzie posiadać archiwum stage-a, które można pobrać oddzielnie,
wypakować z płyty liveCD albo z obrazu .iso tej płyty.  
</p>

<pre caption="Mounting a liveCD .iso">
# <i>mkdir /mnt/loop</i>
# <i>mount -o loop /ścieżka/do/instalacji-&lt;TAB&gt;.iso /mnt/loop</i>
</pre>

<p>
Ustawienia środowiska chrootowalengo są identyczne jak standardowej kompilacji gentoo.
</p>

<pre caption="Creating the Gentoo chroot mount">
# <i>mkdir /mnt/gentoo</i>
# <i>cd /mnt/gentoo</i>
# <i>tar xvjpf /path/to/stage&lt;TAB&gt;.tar.bz2</i>
</pre>

<p>
Na tym etapie można juz odmontować obraz .iso, który nie będzie juz wymagany.
</p>

<p>
Ładowanie początkowe i kompilacja systemu przebiega w standardowy sposób. Należy
podąrzać za instrukcjami instalatora :)
</p>

<p>
Można dodać dodatkowe paczki które są potrzebne indywidualnemu użytkownikowi.
Można nadać dowolną nazwę jako nazwe systemową.  W <path>/etc/fstab</path>
należy ustawić <path>/dev/ROOT</path> jako <path>/dev/ubd/0</path>, dozwolone
systemy plików to: ext2, ext3, or reiserfs.  Jako <path>/dev/SWAP</path>
ustawić <path>/dev/ubd/1</path>, odkomentować <path>/dev/BOOT</path>.
</p>

<p>
Na tym etapie instalacji trzeba ustawić hasło głównego użytkownika.
</p>

<pre caption="Setting root password">
# <i>passwd</i>
</pre>

<p>
Wymagane będzie naniesienie pewnych zmian w skryptach startowych.  Trzeba usunąć
consolefont i keymaps z poziomu uruchomienia "boot":
</p>

<pre caption="Removing unneeded initscripts">
# <i>rc-update del consolefont boot</i>
# <i>rc-update del keymaps boot</i>
</pre>

<p>
Teraz można wyjść ze środowiska chrootowalengo, odmontować wszystkie zdublowane
montowania, oczyścić cąły system.
</p>

<pre caption="Finalising the installation">
# <i>cd /mnt/gentoo</i>
# <i>tar cvjpf ~/gentoo.tbz2 *</i>
# <i>cd</i>
# <i>rm -rf /mnt/gentoo</i>
</pre>

</body>
</section>
<section>
<title>Tworzenie root_fs</title>
<body>

<p>
Nasze środowisko podrzędne zajmuje prawie 300 MB, dlatego 
<path>root_fs</path> wymaga będzie minimalnie tyle wolnego miejsca na dysku.
Rozsądnym rozmiarem będzie zarezerowanie 0.5 GB.
</p>

<pre caption="Creating UML files">
# <i>dd if=/dev/zero of=root_fs seek=500 count=1 bs=1M</i>
# <i>mke2fs -F root_fs</i>
# <i>mount -o loop root_fs /mnt/loop</i>
# <i>tar xvjpf gentoo.tbz2 -C /mnt/loop</i>
# <i>umount /mnt/loop</i>
</pre>

<p>
Przydał by się plik wymiany w rozmiarze 0.5 GB.
</p>

<pre caption="Create swap partition">
# <i>dd if=/dev/zero of=swap_fs seek=500 count=1 bs=1M</i>
# <i>mkswap -f swap_fs</i>
</pre>

<p>
Testujemy nasze ustawienia czy będą poprawne!
</p>

<pre caption="Start UML kernel thread">
# <i>linux ubd0=root_fs ubd1=swap_fs</i>
</pre>

<p>
System w trybie użytkownika używa xterma jako wirtualną konsolę która będzie
uruchamiana w trakcie startu systemu dlatego należy się upewnić czy terminal z
którego będzie uruchamiany system mam poprawnie ustawioną zmienną $DISPLAY
oraz czy użytkownik posiada odpowiednie prawa do xhost/xauth.
</p>

<p>
Przy odrobinie szczęścia będzie możliwe zalogowanie się do systemu w trybie
użytkownika.  Jedyna rzecz jaka powstrzymuje system w trybie użytkownika przed
przerodzeniem się w pełni funkcjonalny system jest nie dokonca działająca sieć w
wirtualnym systemie.  
</p>

</body>
</section>
</chapter>

<chapter>
<title>Sieć</title>
<section>
<body>

<p>
Należy się upewnić czy system gospodarza ma odpowiednie pozycje wkompilowane w
jądro jako moduły:
</p>

<pre caption="Host kernel configuration">
Networking --&gt;
  IP: Netfilter Configuration --&gt;
    IP tables support --&gt;
      Full NAT --&gt;
        &lt;M&gt; MASQUERADE target support 
    
    Network Device Support --&gt; 
      &lt;M&gt; TUN/TAP Support
</pre>

<p>
Uruchom następujące polecenia na systemie <e>gospodarza</e> :
</p>

<pre caption="Setup networking">
# <i>modprobe tun</i>
<comment>(Jeżeli otrzymasz krytyczny błąd można sprobować skasować /dev/net/tun
i spróbować jeszcze raz)</comment>
# <i>modprobe iptable_nat</i>
# <i>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</i>
# <i>echo 1 > /proc/sys/net/ipv4/ip_forward</i>
</pre>

<p>
Tablice IP ustawiają maskowanie IP pomiędzy prywaną siecią na której będzie
działał system w trybie użytkownika a internetem
(osiągalny przez urządzenie <c>eth0</c> w naszym przypadku).  Linia echo po czym
następuje ustawienie przekazywania pakietów pomiędzy siecią prywatną a
interfejsem kŧóry domyślnie jest bramą (eth0 w naszym przypadku).
</p>

<p>
Można uruchomić system i sprawdzić czy funkcjonuje poprawnie.
</p>

<pre caption="Get UML up and running">
# <i>linux ubd0=root_fs ubd1=swap_fs eth0=tuntap,,,192.168.0.254</i>
<comment>(logowanie do systemu wirtualnego)</comment>
# <i>ifconfig eth0 192.168.0.1 up</i>
# <i>ping -c 2 192.168.0.254</i>
PING 192.168.0.254 (192.168.0.254): 56 octets data
64 octets from 192.168.0.254: icmp_seq=0 ttl=255 time=0.8 ms
64 octets from 192.168.0.254: icmp_seq=1 ttl=255 time=0.6 ms

--- 192.168.0.254 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.6/0.7/0.8 ms
# <i>route add default gw 192.168.0.254</i>
# <i>netstat -rn</i>
Kernel IP routing table
Destination  Gateway        Genmask        Flags MSS Window irtt Iface
192.168.0.0  0.0.0.0        255.255.255.0  U      40 0         0 eth0
0.0.0.0      192.168.0.254  0.0.0.0        UG     40 0         0 eth0
# <i>scp user@192.168.0.254:/etc/resolv.conf /etc/resolv.conf</i> <comment>(if needed)</comment>
# <i>ping -c 2 www.gentoo.org</i>
PING www.gentoo.org (207.170.82.202): 56 octets data
64 octets from 207.170.82.202: icmp_seq=0 ttl=240 time=119.6 ms
64 octets from 207.170.82.202: icmp_seq=1 ttl=240 time=92.0 ms

--- www.gentoo.org ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 92.0/105.8/119.6 ms
</pre>

<p>
Na systemie w trybie użytkownika przypisane jest w trybie użytkownika urządzenie
eth0 do sieci prywatnej o adresie 192.168.0.1. System gospodarza posiada adres
192.168.0.254, wysyłamy ping-a aby upewnić się czy siec pomiędzy systemami
funkcjonuje poprawnie.  Linia rutingu dodaje domyślną bramę jako nasz system
Wstepnie można użyć scp w celu otrzymania działającego
<path>/etc/resolv.conf</path> (jeżeli wymagane), wysyłamy ping-a na
www.gentoo.pl aby upewnić się czy mamy dostęp do internetu.  Teraz można
emergować system w trybie użytkownika kiedy tylko będzie to potrzebne! <c>emerge</c>
</p>

</body>
</section>
</chapter>
<chapter>
<title>Testowanie .iso</title>
<section>
<body>

<p>
Prawdopodobnie prawdziwym ideałem gentoo mogłoby być uruchomienie .iso z
systemem użytkownika i dokończenie instalacji  bez konieczności używania systemu
w trybie użytkownika.
</p>

<p>
Uruchomienie .iso, albo initrd z obrazu .iso, jest całkiem proste.
</p>

<pre caption="Booting the ISO">
# <i>mount -o loop /path/to/install-&lt;TAB&gt;.iso /mnt/loop</i>
# <i>cp /mnt/loop/isolinux/gentoo.igz .</i>
# <i>linux load_ramdisk=1 prompt_ramdisk=0 ramdisk_size=22000 \</i>
&gt; <i>initrd=rescue.gz root=/dev/ram0 ubd0=root_fs ubd1=swap_fs \</i>
&gt; <i>ubd2=/dev/cdroms/cdrom0 eth0=tuntap,,,192.168.0.254</i>
</pre>

<p>
Można teraz podązać za elektroniczną dokumentacją instalcji gentoo jedak będzie
wymagana wiedza który system plików będzie główny
<path>/dev/ubd/0</path>, plik wymiany 
będzie <path>/dev/ubd/1</path>, i napęd CD rom 
będzie <path>/dev/ubd/2</path>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Źródła</title>
<section>
<body>

<ul>
  <li>
    <uri link="http://edeca.net/articles/bridging/index.html">Mostkowanie z
    wykorzystaniem UML</uri>
  </li>
  <li>
    <uri link="http://user-mode-linux.sourceforge.net/">Strona domowa UML</uri>
  </li>
  <li>
    <uri link="http://www.theshore.net/~caker/uml/">Notatki UML Caker-a</uri>
  </li>
  <li>
    <uri link="http://sourceforge.net/mailarchive/forum.php?forum_id=3647">
    Archiwum listy dyskusyjnej UML</uri>
  </li>
</ul>

</body>
</section>
</chapter>

</guide>
