<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/www/www.gentoo.org/raw_cvs/gentoo/xml/htdocs/doc/en/gentoo-x86+raid+lvm2-quickinstall.xml,v 1.4 2006/06/29 12:40:50 rane Exp $ -->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/en/gentoo-x86+raid+lvm2-quickinstall.xml" lang="pl">
<title>Szybka instalacja Gentoo z obsługą programowego Raid i LVM2</title>

<author title="Author">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Author">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Author">Steven Wagner</author>
<author title="Tłumaczenie">
  <mail link="rane@gentoo.org">Łukasz Damentko</mail>
</author>
<author title="Tłumaczenie">
  <mail link="jbozanowski@gmail.com">Kuba Bożanowski</mail>
</author>

<abstract>
Skrócony opis instalacji Gentoo z obsługą programowych macierzy dyskowych
raid oraz LVM2. Pozwala na szybką instalację systemu ze
stage3 i jest przeznaczony dla użytkowników z dużym doświadczeniem w
instalowaniu Gentoo.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>2</version>
<date>2006-05-30</date>

<chapter>
<title>Wprowadzenie</title>
<section>
<body>

<p>
Ten dokument zawiera wszystkie polecenia, których wydanie jest konieczne dla
zainstalowania Gentoo za pomocą archiwum stage3, w tym skonfigurowanie
obsługi LVM2 wraz z programową macierzą dyskową RAID. Przewodnik ten jest
przeznaczony dla zaawansowanych użytkowników. Do pobrania archiwum stage3 i
drzewa Portage konieczne będzie działające połączenie z Internetem.
</p>

<p>
Czas podany w opisie został zmierzony na komputerze PC z procesorem AMD 2000
1.66 Ghz, 512 Mb of RAM i dwoma dyskami SATA podłączonymi do sprzętowego
kontrolera, skonfigurowanego jako JBOD (system widzi dwa osobne dyski
twarde). Jeśli płyta główna naszego komputera posiada „sprzętowy” kontroler
RAID, to najprawdopodobniej jednak wcale <b>nie</b> jest on sprzętowy.
</p>

<pre caption="Sprawdzanie komputera">
<comment>(Poniższe polecenia umożliwią obliczenie czasu jaki zajmie instalacja
Gentoo na komputerze o innych parametrach technicznych)</comment>

# <i>grep bogo /proc/cpuinfo</i>
bogomips       : 3337.81

# <i>hdparm -tT /dev/sda /dev/sdb</i>
/dev/sda:
reads:   1048 MB in  2.00 seconds = 524.00 MB/sec
 Timing buffered disk reads:  152 MB in  3.01 seconds =  50.50 MB/sec

/dev/sdb:
 Timing cached reads:   1048 MB in  2.00 seconds = 524.00 MB/sec
 Timing buffered disk reads:  152 MB in  3.01 seconds =  50.50 MB/sec

# <i>grep MemTotal /proc/meminfo</i>
MemTotal:       509248 kB
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Szybka instalacja</title>
<section>
<title>Płyty instalacyjne</title>
<body>

<p>
Pobieramy płytę z jednego z <uri link="/main/en/mirrors.xml">serwerów
lustrzanych</uri>. Minimalne pliki ISO są w katalogu
<path>releases/x86/&lt;release&gt;/installcd</path>, pełne płyty instalacyjne w
<path>releases/x86/&lt;release&gt;/livecd</path>. Płyta minimalna przydaje się
tylko wtedy, gdy komputer jest podłączony do Internetu. Płyta pełna służy do
instalowania Gentoo bez dostępu do sieci, w takim przypadku należy skorzystać z
<uri link="/doc/pl/handbook/2006.0/handbook-x86.xml">Podręcznika Gentoo
2006.0</uri>. Jeśli chodzi o ten opis, należy pobrać płytę minimalną.
</p>

<p>
<uri link="/doc/pl/faq.xml#isoburning">Nagrywamy</uri> i uruchamiamy płytę
instalacyjną.
</p>

</body>
</section>
<section>
<title>Uruchamianie systemu płyty instalacyjnej</title>
<body>

<p>
Wciskamy <c>F2</c> na ekranie uruchamiania, aby poznać możliwe do wybrania
opcje. Można uruchomić <c>gentoo</c> lub <c>gentoo-nofb</c>, to drugie wyłącza
framebuffer. Dodajemy opcję <c>nox</c>, aby nie ładowało się środowisko
graficzne. Inne opcje pozwalają na włączenie lub wyłączenie rozmaitych
dodatkowych funkcji. Jeśli wszystko pójdzie dobrze, sprzęt zostanie poprawnie
wykryty, a odpowiednie sterowniki załadowane. Jeśli jądro się nie uruchomi lub
komputer się zawiesi, należy poeksperymentować z różnymi ustawieniami.
Najbezpieczniejsza jest opcja <c>nodetect</c> - po wydaniu której sami ręcznie
możemy załadować potrzebne moduły.
</p>

<pre caption="Uruchamianie systemu płyty instalacyjnej">
Gentoo Linux Installation LiveCD                     http://www.gentoo.org
Enter to Boot; F1 for kernels  F2 for options.
boot: <i>gentoo-nofb</i>
  <comment>(w razie problemów)</comment>
boot: <i>gentoo-nofb nodetect</i>
</pre>

</body>
</section>
<section>
<title>Opcjonalnie: ładowanie modułów</title>
<body>

<p>
Jeśli skorzystamy z opcji <c>nodetect</c>, po uruchomieniu będzie konieczne
ręczne załadowanie niezbędnych do obsługi sprzętu modułów. Konieczne jest
zapewnienie połączenia z Internetem i obsługi dysków. Program <c>lspci</c>
umożliwia wykrycie używanego sprzętu.
</p>

<pre caption="Ładowanie potrzebnych modułów">
livecd root # <i>lspci</i>
<comment>(Korzystamy z wyniku tego polecenia w celu określenia, które moduły są potrzebne)</comment>

<comment>(A następnie je ładujemy)</comment>
livecd root # <i>modprobe 3w-9xxx</i>
livecd root # <i>modprobe r8169</i>
</pre>

</body>
</section>
<section>
<title>Konfiguracja sieci</title>
<body>

<p>
Jeśli połączenie sieciowe jeszcze nie działa, należy skorzystać z programu
<c>net-setup</c> w celu jego konfiguracji. Możliwe też, że przed
przystąpieniem do konfiguracji konieczne będzie załadowanie dodatkowych
modułów za pomocą polecenia <c>modprobe</c>. Posiadacze ADSL powinni
skorzystać z <c>adsl-setup</c> i <c>adsl-start</c>. Jeśli jednak mamy router
ADSL, nie ma potrzeby uruchamiać tych skryptów, gdyż urządzenie to samo
nawiąże połączenie. Aby zadziałało PPTP, należy edytować
<path>/etc/ppp/chap-secrets</path> i <path>/etc/ppp/options.pptp</path>, a
następnie użyć <c>pptp &lt;numer&nbsp;ip&nbsp;serwera&gt;</c>.
</p>

<p>
Połączenia bezprzewodowe konfiguruje się za pomocą <c>iwconfig</c>, a dopiero
potem uruchamia <c>net-setup</c>, <c>ifconfig</c>, <c>dhcpcd</c> oraz, jeśli to
jest konieczne, <c>route</c>.
</p>

<p>
Jeśli komputer znajduje się za serwerem proxy, należy za pomocą polecenia
export ustawić odpowiednio zmienne <c>http_proxy</c>, <c>ftp_proxy</c> i
<c>RSYNC_PROXY</c>.
</p>

<pre caption="Konfiguracja sieci za pomocą kreatora">
livecd root # <i>net-setup eth0</i>
</pre>

<p>
Można również skonfigurować sieć ręcznie. W poniższym przykładzie przypisujemy
komputerowi adres 192.168.1.10 oraz ustawiamy 192.168.1.1 jako router i serwer
nazw.
</p>

<pre caption="Ręczna konfiguracja sieci">
livecd root # <i>ifconfig eth0 192.168.1.10/24</i>
livecd root # <i>route add default gw 192.168.1.1</i>
livecd root # <i>echo nameserver 192.168.1.1 > /etc/resolv.conf</i>
</pre>

<p>
Płyta instalacyjna umożliwia uruchomienie serwera <c>sshd</c>. Możemy również
dodać konta użytkowników i uruchomić <c>irssi</c> (tekstowy klient IRC) oraz
przeglądać sieć za pomocą <c>lynx</c> i <c>links</c>.
</p>

</body>
</section>
<section>
<title>Opcjonalnie: konfiguracja serwera SSH</title>
<body>

<p>
Serwer <c>sshd</c> umożliwia łączenie się z komputerem, na którym instalujemy
Gentoo z innych maszyn oraz zdalną instalację.
</p>

<pre caption="Uruchamianie sshd">
livecd root # <i>time /etc/init.d/sshd start</i>
 * Generating hostkey ...
<comment>(sshd tworzy klucze, wyświetla dalsze informacje)</comment>
 * starting sshd ...                            [ok]

real   0m13.688s
user   0m9.420s
sys    0m0.090s
</pre>

<p>
Następnie ustawiamy hasło roota na płycie instalacyjnej, co umożliwi łączenie
się z innego komputera. Ostrzegamy, że umożliwianie takich połączeń w
normalnych warunkach jest bardzo niebezpieczne. Jeśli sieć nie jest bezpieczna,
należy ustawić długie i mocne hasło oraz nie korzystać z takich opcji w
przyszłości. Serwer SSH zostanie wyłączony po ponownym uruchomieniu komputera.
</p>

<pre caption="Ustawianie hasła roota">
livecd root # <i>passwd</i>
New UNIX password: <comment>wpisz_hasło</comment>
Retype new UNIX password: <comment>wpisz_hasło</comment>
passwd: password updated successfully
</pre>

<p>
Teraz można uruchomić terminal na drugim komputerze, połączyć się z nową
maszyną i kontynuować instalację zdalnie, przeklejając polecenia z tego opisu.
</p>

<pre caption="Łączenie z innego komputera">
<comment>(Wpisujemy adres IP komputera, na którym instalujemy Gentoo)</comment>
$ <i>ssh root@192.168.1.10</i>
The authenticity of host '192.168.1.10 (192.168.1.10)' can't be established.
RSA key fingerprint is 96:e7:2d:12:ac:9c:b0:94:90:9f:40:89:b0:45:26:8f.
Are you sure you want to continue connecting (yes/no)? <i>yes</i>
Warning: Permanently added '192.168.1.10' (RSA) to the list of known hosts.
Password: <comment>wpisz_hasło</comment>
</pre>

</body>
</section>
<section>
<title>Przygotowywanie dysków</title>
<body>

<p>
Teraz należy załadować moduły RAID i LVM2.
</p>

<pre caption="Ładowanie modułów RAID i LVM2">
livecd ~ # <i>modprobe raid0</i>
livecd ~ # <i>modprobe raid1</i>
<comment>(dostępne są także raid5, raid6 i raid10)</comment>

livecd ~ # <i>modprobe dm-mod</i>
</pre>

<p>
Dzielimy dysk na partycje za pomocą programu <c>fdisk</c> lub <c>cfdisk</c>.
Prawdopodobne nazwy urządzeń twardego dysku to <path>/dev/sda</path> i
<path>/dev/sdb</path> dla dysków SATA i SCSI lub <path>/dev/hda</path> i
<path>/dev/hdb</path>dla dysków IDE. W niniejszym dokumencie zostanie użyty
następujący układ: FIXME (mirroring, striped)
</p>

<table>
  <tr>
    <ti/>
    <th><path>/dev/sda</path></th>
    <th><path>/dev/sdb</path></th>
    <th>Typ</th>
  </tr>
  <tr>
    <th><path>/dev/md1</path></th>
    <th><path>/boot</path></th>
    <th><path>/boot</path></th>
    <ti>Raid-1 (mirroring)</ti>
  </tr>
  <tr>
    <th/>
    <th>swap</th>
    <th>swap</th>
    <ti>Normalne partycje</ti>
  </tr>
  <tr>
    <th><path>/dev/md3</path></th>
    <th><path>/</path></th>
    <th><path>/</path></th>
    <ti>Raid-1 (mirroring)</ti>
  </tr>
  <tr>
    <th><path>/dev/md4</path></th>
    <th colspan="2">Woluminy LVM2</th>
    <ti>Raid-0 (przeplatanie)</ti>
  </tr>
</table>

<note>
Partycja, z której będzie uruchamiany system nie może być przeplatana. Nie
może być typu raid-5 lub raid-0.
</note>

<note>
Z jednej strony, chcąc uzyskać większą stabilność, warto zastanowić się nad
użyciem raid-1 (lub nawet raid-5) na partycji (partycjach) wymiany. Wówczas
awaria dysku nie uszkodzi danych wymiany i nie spowoduje awarii aplikacji,
które z nich korzystają. Z drugiej strony, chcąc uzyskać większą wydajność,
można pozwolić kernelowi na użycie osobnych partycji wymiany, ponieważ i tak
domyślnie dane między nimi będą przeplatane.
</note>

<pre caption="Tworzenie partycji">
livecd ~ # <i>fdisk /dev/sda</i>
<comment>(Należy pamiętać, aby użyć typ fd)</comment>

<comment>(W dalszej częsci opisu będziemy posługiwać się następującym podziałem:)</comment>
livecd ~ # <i>fdisk -l /dev/sda</i>

Disk /dev/sda: 299.9 GB, 299989204992 bytes
255 heads, 63 sectors/track, 36471 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1               1          11       88326   fd  Linux raid autodetect
/dev/sda2              12          61      401625   82  Linux swap / Solaris
/dev/sda3              62         311     2008125   fd  Linux raid autodetect
/dev/sda4             312       36471   290455200   fd  Linux raid autodetect

<comment>(Drugi dysk należy podzielić na partycje identycznie jak pierwszy)</comment>
livecd ~ # <i>fdisk /dev/sdb</i>
</pre>

<p>
Następnie należy stworzyć węzły urządzeń RAID i same urządzenia:
</p>

<pre caption="Tworzenie węzłów urządzeń i urządzeń">
livecd ~ # <i>mknod /dev/md1 b 9 1</i>
livecd ~ # <i>mknod /dev/md3 b 9 3</i>
livecd ~ # <i>mknod /dev/md4 b 9 4</i>

livecd ~ # <i>mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</i>
mdadm: array /dev/md1 started.
livecd ~ # <i>mdadm --create /dev/md3 --level=1 --raid-devices=2 /dev/sda3 /dev/sdb3</i>
mdadm: array /dev/md3 started.
livecd ~ # <i>mdadm --create /dev/md4 --level=0 --raid-devices=2 /dev/sda4 /dev/sdb4</i>
mdadm: array /dev/md4 started.

<comment>(Poczekajmy aż wszystkie jednostki będą gotowe)</comment>
livecd ~ # <i>cat /proc/mdstat</i>
Personalities : [raid0] [raid1]
md4 : active raid0 sdb4[1] sda4[0]
581006592 blocks 64k chunks

md3 : active raid1 sdb3[1] sda3[0]
1959808 blocks [2/2] [UU]

md1 : active raid1 sdb1[1] sda1[0]
88256 blocks [2/2] [UU]
</pre>

<p>
Następnie stwórzmy woluminy LVM2 na <path>/dev/md4</path>. Następujący układ
jest jedynie <b>przykładowy</b>:
</p>

<table>
<tr>
  <th>Ścieżka</th>
  <th>Rozmiar</th>
  <th>System plików</th>
</tr>
<tr>
  <ti>/usr</ti>
  <ti>8 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/usr/portage</ti>
  <ti>2 GB</ti>
  <ti>ext2, FIXME small block size, many inodes</ti>
</tr>
<tr>
  <ti>/usr/portage/distfiles</ti>
  <ti>4 GB</ti>
  <ti>ext2, large bock size, less inodes</ti>
</tr>
<tr>
  <ti>/home</ti>
  <ti>10 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/opt</ti>
  <ti>4 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/var</ti>
  <ti>4 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/var/tmp</ti>
  <ti>6 GB</ti>
  <ti>ext2</ti>
</tr>
<tr>
  <ti>/tmp</ti>
  <ti>2 GB</ti>
  <ti>ext2</ti>
</tr>
</table>

<pre caption="Tworzenie woluminów LVM2">
livecd ~ # <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
livecd ~ # <i>vgchange -a y</i>
  No volume groups found

<comment>(Tworzymy fizyczne woluminy, w naszym przykładzie jest tylko jeden)</comment>
livecd ~ # <i>pvcreate /dev/md4</i>
  Physical volume "/dev/md4" successfully created

<comment>(Tworzymy grupy woluminów, jak wyżej, tu mamy tylko jedną)</comment>
livecd ~ # <i>vgcreate vg /dev/md4</i>
  Volume group "vg" successfully created

<comment>(Tworzymy logiczne woluminy)</comment>
livecd ~ # <i>lvcreate -L8G -nusr vg</i>
  /dev/cdrom: open failed: Read-only file system
  Logical volume "usr" created <comment>(Pominięto dalsze podobne komunikaty)</comment>
livecd ~ # <i>lvcreate -L2G -nportage vg</i>
livecd ~ # <i>lvcreate -L4G -ndistfiles vg</i>
livecd ~ # <i>lvcreate -L10G -nhome vg</i>
livecd ~ # <i>lvcreate -L4G -nopt vg</i>
livecd ~ # <i>lvcreate -L4G -nvar vg</i>
livecd ~ # <i>lvcreate -L6G -nvartmp vg</i>
livecd ~ # <i>lvcreate -L2G -ntmp vg</i>

<comment>(Wyświetlamy grupy woluminów i woluminy logiczne)</comment>
livecd ~ # <i>vgs</i>
  VG   #PV #LV #SN Attr  VSize   VFree
  vg     1   8   0 wz--n 554.09G 514.09G
livecd ~ # <i>lvs</i>
  LV        VG   Attr   LSize  Origin Snap%  Move Copy%
  distfiles vg   -wi-a-  4.00G
  home      vg   -wi-a- 10.00G
  opt       vg   -wi-a-  4.00G
  portage   vg   -wi-a-  2.00G
  tmp       vg   -wi-a-  2.00G
  usr       vg   -wi-a-  8.00G
  var       vg   -wi-a-  4.00G
  vartmp    vg   -wi-a-  6.00G
</pre>

<p>
Następnie za pomocą <c>mke2fs</c>, <c>mke2fs -j</c>, <c>mkreiserfs</c>,
<c>mkfs.xfs</c> lub <c>mkfs.jfs</c> tworzymy systemy plików na partycjach
linuksowych.  Aktywujemy też partycję wymiany za pomocą poleceń
<c>mkswap</c> i <c>swapon</c>.
</p>

<pre caption="Tworzenie systemów plików i aktywowanie partycji wymiany">
<comment>(ext2 wystarczy dla partycji /boot)</comment>
livecd ~ # <i>mke2fs /dev/sda1</i>

<comment>(Główna partycja będzie na ext3)</comment>
livecd ~ # <i>mke2fs -j -O dir_index /dev/md3</i>

<comment>(Tworzymy systemy plików na woluminach logicznych)</comment>
livecd ~ # <i>mke2fs -b 4096 -T largefile /dev/vg/distfiles</i>
livecd ~ # <i>mke2fs -j -O dir_index /dev/vg/home</i>
livecd ~ # <i>mke2fs -j -O dir_index /dev/vg/opt</i>
livecd ~ # <i>mke2fs -b 1024 -N 200000 /dev/vg/portage</i>
livecd ~ # <i>mke2fs /dev/vg/tmp</i>
livecd ~ # <i>mke2fs -j -O dir_index /dev/vg/usr</i>
livecd ~ # <i>mke2fs -j -O dir_index /dev/vg/var</i>
livecd ~ # <i>mke2fs /dev/vg/vartmp</i>

<comment>(Tworzymy i aktywujemy partycję wymiany)</comment>
livecd ~ # <i>mkswap /dev/sda2 &amp;&amp; mkswap /dev/sdb2</i>
livecd ~ # <i>swapon -p 1 /dev/sda2 &amp;&amp; swapon -p 1 /dev/sdb2</i>
<comment>(Sprawdźmy czy wszystkie partycje wymiany używają tego samego priorytetu)</comment>
livecd ~ # <i>swapon -v -s</i>
Filename                   Type            Size    Used    Priority
/dev/sda2                  partition       401616  0       1
/dev/sdb2                  partition       401616  0       1
</pre>

<p>
Montujemy główną partycję w katalogu <path>/mnt/gentoo</path>. W razie potrzeby
tworzymy katalogi dla dodatkowych partycji i montujemy je również.
</p>

<pre caption="Montowanie systemów plików">
livecd ~ # <i>mount /dev/md3 /mnt/gentoo</i>
livecd ~ # <i>cd /mnt/gentoo</i>
livecd gentoo # <i>mkdir boot home usr opt var tmp</i>
livecd gentoo # <i>mount /dev/md1 /mnt/gentoo/boot</i>
livecd gentoo # <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
livecd gentoo # <i>mount /dev/vg/home /mnt/gentoo/home</i>
livecd gentoo # <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
livecd gentoo # <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
livecd gentoo # <i>mount /dev/vg/var /mnt/gentoo/var</i>
livecd gentoo # <i>mkdir usr/portage var/tmp</i>
livecd gentoo # <i>mount /dev/vg/vartmp /mnt/gentoo/var/tmp</i>
livecd gentoo # <i>mount /dev/vg/portage /mnt/gentoo/usr/portage</i>
livecd gentoo # <i>mkdir usr/portage/distfiles</i>
livecd gentoo # <i>mount /dev/vg/distfiles /mnt/gentoo/usr/portage/distfiles</i>

<comment>(Należy ustawić odpowiednie uprawnienia dla katalogów tmp)</comment>
livecd gentoo # <i>chmod 1777 /mnt/gentoo/tmp /mnt/gentoo/var/tmp</i>
</pre>

</body>
</section>
<section>
<title>Rozpakowywanie archiwum stage</title>
<body>

<p>
Po pierwsze ustawiamy datę za pomocą polecenia <c>date MMDDRRRR</c>. W
przykładzie używamy czasu UTC.
</p>

<pre caption="Ustawianie daty i czasu UTC">
<comment>(Sprawdzamy godzinę)</comment>
livecd gentoo # <i>date</i>
Mon Mar  6 00:14:13 UTC 2006

<comment>(Ustawiamy datę i godzinę jeśli jest to konieczne)</comment>
livecd gentoo # <i>date 030600162006</i> <comment>(Format is MMDDhhmmYYYY)</comment>
Mon Mar  6 00:16:00 UTC 2006
</pre>

<p>
Następnie pobieramy archiwum stage z jednego z <uri
link="/main/en/mirrors.xml">serwerów lustrzanych</uri>. Przechodzimy do
<path>/mnt/gentoo</path> i rozpakowujemy je poleceniem <c>tar xjpf &lt;plik
stage3&gt;</c>.
</p>

<pre caption="Pobieranie archiwum stage3">
livecd gentoo # <i>links http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(Wybieramy serwer i przechodzimy do katalogu releases/x86/current/stages,
wybierając z niego odpowiedni plik, np. stage3-i686-2006.0.tar.bz2)</comment>

<comment>(<b>Lub</b> pobieramy plik bezpośrednio, nie szukając znajdującego się najbliżej serwera)</comment>
livecd gentoo # <i>wget http://gentoo.osuosl.org/releases/x86/current/stages/stage3-i686-2006.0.tar.bz2</i>
</pre>

<pre caption="Rozpakowujemy archiwum">
livecd gentoo # <i>time tar xjpf stage3*</i>

real  1m14.157s
user  1m2.920s
sys   0m7.530s
</pre>

<p>
Następnie instalujemy drzewo Portage. Postępujemy z nim tak jak ze stage3.
Wybieramy <uri link="/main/en/mirrors.xml">serwer lustrzany</uri>, pobieramy
plik i rozpakowujemy.
</p>

<pre caption="Pobieranie drzewa Portage">
livecd gentoo # <i>cd /mnt/gentoo/usr</i>
livecd usr # <i>links http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(Wybieramy serwer, przechodzimy do katalogu snapshots/, podświetlamy
<b>portage-latest.tar.bz2</b> i wciskamy D żeby go pobrać)</comment>

<comment>(<b>Lub</b> pobieramy go bezpośrednio, nie szukając znajdującego się najbliżej serwera)</comment>
livecd gentoo # <i>cd /mnt/gentoo/usr</i>
livecd usr # <i>wget http://gentoo.osuosl.org/snapshots/portage-latest.tar.bz2</i>
</pre>

<pre caption="Rozpakowujemy archiwum z drzewem Portage">
livecd usr # <i>time tar xjf portage-lat*</i>

real  0m40.523s
user  0m28.280s
sys   0m8.240s
</pre>

</body>
</section>
<section>
<title>Chrootowanie</title>
<body>

<p>
Montujemy system plików <path>/proc</path>, kopiujemy do nowego systemu plik
<path>/etc/resolv.conf</path> i chrootujemy się do instalowanego systemu.
</p>

<pre caption="Chrootowanie">
livecd usr # <i>cd /</i>
livecd / # <i>mount -t proc proc /mnt/gentoo/proc</i>
livecd / # <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/</i>
livecd / # <i>chroot /mnt/gentoo /bin/bash</i>
livecd / # <i>env-update &amp;&amp; source /etc/profile</i>
>>> Regenerating /etc/ld.so.cache...
</pre>

</body>
</section>
<section>
<title>Konfiguracja strefy czasowej</title>
<body>

<p>
Kopiujemy plik z odpowiednią strefą czasową z katalogu
<path>/usr/share/zoneinfo</path> do pliku <path>/etc/localtime</path>.
</p>

<pre caption="Kopiowanie pliku strefy czasowej">
<comment>(Przykład dla Warszawy)</comment>
livecd / # <i>cp /usr/share/zoneinfo/Europe/Warsaw /etc/localtime</i>
livecd / # <i>date</i>
Wed Mar  8 00:46:05 CET 2006
</pre>

</body>
</section>
<section>
<title>Konfiguracja nazw hosta i domeny</title>
<body>

<p>
Set your host name in <path>/etc/conf.d/hostname</path> and
<path>/etc/hosts</path>. In the following example, we use
<c>mybox</c> as host name and <c>at.myplace</c> as domain name.  You can either
edit the config files with <c>nano</c> or use the following commands:
</p>

<pre caption="Set host and domain name">
livecd / # <i>cd /etc</i>
livecd etc # <i>echo "127.0.0.1 mybox.at.myplace mybox localhost" > hosts</i>
livecd etc # <i>sed -i -e 's/HOSTNAME.*/HOSTNAME="mybox"/' conf.d/hostname</i>
<comment>(Use defined host name and check)</comment>
livecd etc # <i>hostname mybox</i>
livecd etc # <i>hostname -f</i>
mybox.at.myplace
</pre>

</body>
</section>
<section>
<title>Kernel Configuration</title>
<body>

<p>
Install a kernel source (usually <c>gentoo-sources</c> or
<c>vanilla-sources</c>), configure it, compile it and copy the
<path>arch/i386/boot/bzImage</path> file to <path>/boot</path>.
</p>

<pre caption="Install a kernel source, compile it and install the kernel">
livecd etc # <i>time emerge gentoo-sources</i>

real  3m3.110s
user  1m2.320s
sys   0m34.990s
livecd etc # <i>cd /usr/src/linux</i>
livecd linux # <i>make menuconfig</i>

<comment>(Configure your kernel as usual and make sure the raid and lvm modules you need are
compiled in, i.e. <b>not</b> as modules. The same applies to the disk drivers and filesystems.)</comment>
Multi-device support (RAID and LVM)  --->
[*] Multiple devices driver support (RAID and LVM)
  &lt;*&gt;   RAID support
  &lt; &gt;     Linear (append) mode (NEW)
  &lt;*&gt;     RAID-0 (striping) mode
  &lt;*&gt;     RAID-1 (mirroring) mode
  &lt; &gt;     RAID-10 (mirrored striping) mode (EXPERIMENTAL) (NEW)
  &lt; &gt;     RAID-4/RAID-5 mode (NEW)
  &lt; &gt;     RAID-6 mode (NEW)
  &lt; &gt;     Multipath I/O support (NEW)
  &lt; &gt;     Faulty test module for MD (NEW)
  &lt;*&gt;   Device mapper support
  &lt; &gt;     Crypt target support (NEW)
  &lt; &gt;     Snapshot target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Mirror target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Zero target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Multipath target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Bad Block Relocation Device Target (EXPERIMENTAL) (NEW)

livecd linux # <i>time make -j2</i>

<comment>(Elapsed time depends highly on the options you selected)</comment>
real  5m5.869s
user  4m32.320s
sys   0m32.930s

livecd linux # <i>make modules_install</i>
livecd linux # <i>cp arch/i386/boot/bzImage /boot/kernel</i>
</pre>

</body>
</section>
<section>
<title>Configure the system</title>
<body>

<p>
Edit your <path>/etc/fstab</path> and replace <c>BOOT</c>, <c>ROOT</c> and
<c>SWAP</c> with the actual partition names and add your logical volumes. Don't
forget to check that the file systems match your installation.
</p>

<pre caption="Example fstab">
livecd linux # <i>cd /etc</i>
livecd etc # <i>nano -w fstab</i>
/dev/<i>md1</i>          /boot                   ext2  noauto,noatime  1 2
/dev/<i>md3</i>          /                       ext3  noatime         0 1
/dev/<i>sda2</i>         none                    swap  sw,pri=1        0 0
/dev/<i>sdb2</i>         none                    swap  sw,pri=1        0 0
/dev/vg/usr       /usr                    ext3  noatime         1 2
/dev/vg/portage   /usr/portage            ext2  noatime         1 2
/dev/vg/distfiles /usr/portage/distfiles  ext2  noatime         1 2
/dev/vg/home      /home                   ext3  noatime         1 2
/dev/vg/opt       /opt                    ext3  noatime         1 2
/dev/vg/tmp       /tmp                    ext2  noatime         1 2
/dev/vg/var       /var                    ext3  noatime         1 2
/dev/vg/vartmp    /var/tmp                ext2  noatime         1 2
</pre>

<p>
Configure your network in <path>/etc/conf.d/net</path>. Add the <c>net.eth0</c>
init script to the default run level. If you have multiple NICs, symlink them
to the <c>net.eth0</c> init script and add them to the default run level as
well. Either edit <path>/etc/conf.d/net</path> with <c>nano</c> or use the
following commands:
</p>

<pre caption="Configure networking">
livecd etc # <i>cd conf.d</i>
livecd conf.d # <i>echo 'config_eth0=( "192.168.1.10/24" )' >> net</i>
livecd conf.d # <i>echo 'routes_eth0=( "default via 192.168.1.1" )' >> net</i>
livecd conf.d # <i>rc-update add net.eth0 default</i>
<comment>(If you compiled your network card driver as a module,
add it to /etc/modules.autoload.d/kernel-2.6)</comment>
livecd conf.d # <i>echo r8169 >> /etc/modules.autoload.d/kernel-2.6</i>
<comment>(If you want to reconnect via ssh after you have rebooted your new box)</comment>
livecd conf.d # <i>rc-update add sshd default</i>
</pre>

<note>
Emerge <c>pcmcia-cs</c> and add it to the default run level if you need it.
</note>

<p>
Set the root password using <c>passwd</c>.
</p>

<pre caption="Set the root password">
livecd conf.d # <i>passwd</i>
New UNIX password: <comment>type_the_password</comment>
Retype new UNIX password: <comment>type_the_password_again</comment>
passwd: password updated successfully
</pre>

<p>
Check the system configuration in <path>/etc/rc.conf</path>,
<path>/etc/conf.d/rc</path>, <path>/etc/conf.d/keymaps</path>,
<path>/etc/conf.d/clock</path> and edit any of those files if required.
</p>

<pre caption="Optional: edit some config files">
livecd conf.d # <i>nano -w /etc/rc.conf</i>
livecd conf.d # <i>nano -w /etc/conf.d/rc</i>
livecd conf.d # <i>nano -w /etc/conf.d/keymaps</i>
livecd conf.d # <i>nano -w /etc/conf.d/clock</i>
</pre>

</body>
</section>
<section>
<title>Installing System Tools</title>
<body>

<p>
Install RAID and LVM2 utilities.
</p>

<pre caption="Install RAID &amp; LVM2 tools">
livecd conf.d # <i>emerge mdadm lvm2</i>
</pre>

<p>
Install a system logger like <c>syslog-ng</c> and a cron daemon like
<c>vixie-cron</c>, and add them to the default run level.
</p>

<note>
Cron daemons depend on an MTA. <c>mail-mta/ssmtp</c> will be pulled in as a
dependency. If you want to use a more advanced MTA, you might want to install
it now. If you are in a hurry, let ssmtp be installed and remove it later when
you install the MTA of your choice.
</note>

<pre caption="Install a syslogger and a cron daemon">
livecd conf.d # <i>time emerge syslog-ng vixie-cron</i>

real  1m54.099s
user  1m2.630s
sys   0m34.620s
livecd conf.d # <i>rc-update add syslog-ng default</i>
livecd conf.d # <i>rc-update add vixie-cron default</i>
</pre>

<p>
Install the necessary file system tools (<c>xfsprogs</c>, <c>reiserfsprogs</c>
or <c>jfsutils</c>) and networking tools (<c>dhcpcd</c> or <c>rp-pppoe</c>) if
you need any.
</p>

<pre caption="Install extra tools if required">
livecd conf.d # <i>emerge xfsprogs</i>           <comment>(If you use the XFS file system)</comment>
livecd conf.d # <i>emerge jfsutils</i>           <comment>(If you use the JFS file system)</comment>
livecd conf.d # <i>emerge reiserfsprogs</i>      <comment>(If you use the Reiser file system)</comment>
livecd conf.d # <i>emerge dhcpcd</i>             <comment>(If you need a DHCP client)</comment>
livecd conf.d # <i>USE="-X" emerge rp-pppoe</i>  <comment>(If you need PPPoE ADSL connectivity)</comment>
</pre>

</body>
</section>
<section>
<title>Configuring the Bootloader</title>
<body>

<p>
Emerge <c>grub</c> and configure it.
</p>

<pre caption="Emerge grub and edit its configuration file">
livecd conf.d # <i>time emerge grub</i>

real  1m4.634s
user  0m39.460s
sys   0m15.280s
livecd conf.d # <i>nano -w /boot/grub/grub.conf</i>
</pre>

<pre caption="Example grub.conf">
default 0
timeout 10

title=Gentoo
root (hd0,0)
kernel /boot/kernel root=/dev/md3
</pre>

<pre caption="Install grub on both disks">
livecd conf.d # <i>grub</i>
Probing devices to guess BIOS drives. This may take a long time.

grub> <i>root (hd0,0)</i>
 Filesystem type is ext2fs, partition type 0x83

grub> <i>setup (hd0)</i>
 Checking if "/boot/grub/stage1" exists... yes
 Checking if "/boot/grub/stage2" exists... yes
 Checking if "/boot/grub/e2fs_stage1_5" exists... yes
 Running "embed /boot/grub/e2fs_stage1_5 (hd0)"...  16 sectors are embedded.
succeeded
 Running "install /boot/grub/stage1 (hd0) (hd0)1+16 p (hd0,0)/boot/grub/stage2 /boot/
grub/menu.lst"... succeeded
Done.

grub> <i>root (hd1,0)</i>
 Filesystem type is ext2fs, partition type 0x83

grub> <i>setup (hd1)</i>

grub> <i>quit</i>
</pre>

</body>
</section>
<section>
<title>Reboot</title>
<body>

<p>
Exit the chrooted environment, unmount all file systems and reboot:
</p>

<pre caption="Reboot">
livecd conf.d # <i>exit</i>
livecd / # <i>umount /mnt/gentoo/usr/portage/distfiles /mnt/gentoo/usr/portage /mnt/gentoo/usr</i>
livecd / # <i>umount /mnt/gentoo/var/tmp /mnt/gentoo/tmp /mnt/gentoo/var /mnt/gentoo/opt</i>
livecd / # <i>umount /mnt/gentoo/proc /mnt/gentoo/home /mnt/gentoo/boot /mnt/gentoo</i>
livecd / # <i>reboot</i>
<comment>(Don't forget to remove the CD)</comment>
</pre>

<p>
Please follow the <uri
link="gentoo-x86-quickinstall.xml#after-reboot">Finalizing the
Installation</uri> part of the regular x86 quick setup guide to complete your
installation.
</p>

</body>
</section>
</chapter>
</guide>
