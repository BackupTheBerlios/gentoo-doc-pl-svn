<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/pl/base/amd64/howtos/chroot.xml,v 1.5 2005/08/31 15:47:25 metalgod Exp $ -->

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->

<sections>

<version>1.0.2</version>
<date>2005-08-31</date>

<section>
<title>Wprowadzenie</title>
<subsection>
<title>Wprowadzenie do 64-bitowego systemu</title>
<body>
<p>
Przewodnik The Gentoo Linux 32bits chroot pomaga ustawić prawdziwy 32-bitowy chroot na systemie Gentoo/AMD64. 
</p>
<p>
Jak wiemy systemy 64-bitowe nie obsługują jeszcze 32-bitowych aplikacji (przynajmniej nie z portage), więc będziemy musieli skożystać z bibliotek emulacji by zmusić je do działania, bądź też stworzyć prawdziwy 32-bitowy system wewnątrz chroot'a, by zainstalować i uruchamiać 32-bitowe aplikacje. Dla zwykłych potrzeb nie musimy budować prawdziwego 32-bitowego systemu wewnątrz chroot'a. Jednakże, jeżeli chcemy uruchamiać aplikacje, które nie posiadają binariów umozliwiających pracę z 32-bitowymi bibliotekami, musimy skożystać 32-bitowego chroot'a. Przewodnik ten uczy jak utworzyć 32-bitowy chroot oraz jak zainstalować i uruchamiać w nim aplikacje.
</p>
</body>
</subsection>
</section>

<section>
<title>Instalacja</title>
<subsection>
<title>Instalacja 32-bitowego chroot'a</title>
<body>
<p>
By zainstalować 32-bitowy chroot podążamy radami jakimi kierujemy się podczas instalacji Gentoo Linux na systemie x86. W tej chwili potrzebujemy najnowszego stage3, dostępnego na <uri link="http://www.gentoo.org/main/en/mirrors.xml">Gentoo mirrors</uri>.
</p>
<pre caption="ściąganie stage3 z gentoo mirror">
$ cd /home/user/downloads
$ wget -c http://distfiles.gentoo.org/releases/x86/2005.0/stages/athlon-xp/stage3-athlon-xp-2005.0.tar.bz2
</pre>
<note>Należy zwrócić uwagę, iż ściągamy wersję stage dla x86, <c>nie</c> dla AMD64.</note>
<p>
Po ukończeniu ściągania musimy stworzyć miejsce dla nowego chroot'a.
</p>
<pre caption="tworzenie katalogu dla 32-bitowego chroot'a">
$ su root <i>wprowadzamy hasło root'a</i>
# cd /mnt
# mkdir gentoo32
</pre>
<p>
Następnie przenosimy ściągnięty stage, rozpakowujemy i instalujemy według przykładu.
</p>
<pre caption="instalacja ze stage3">
# cd /mnt/gentoo32
# tar -xvjpf /home/user/downloads/stage3-athlon-xp-2005.0.tar.bz2
# cp -L /etc/resolv.conf /mnt/gentoo32/etc/
# cp -L /etc/passwd /mnt/gentoo32/etc/
</pre>
<p>
W tej chwili mamy gotowy do tworzenia chroot. Kolejny rozdział pokazuje jak to się odbywa.
</p>
</body>
</subsection>
</section>

<section>
<title>Tworzenie</title>
<subsection>
<title>Tworzenie 32-bitowego chroot'a</title>
<body>
<p>
Jeżeli nie napotkaliśmy żadnych błędów, możemy śmiało rozpocząć tworzenie i sfinalizować instalację 32-bitowego chroot'a.
</p>
<p>
Kolejnym krokiem jest utworzenie nowego <c>/mnt/gentoo32/etc/make.conf</c>.
</p>
<pre caption="Konfiguracja nowego make.conf">
CFLAGS="-O2 -march=athlon-xp -msse2 -pipe -fomit-frame-pointer"
CHOST="i686-pc-linux-gnu"
CXXFLAGS="${CFLAGS}"
MAKEOPTS="-j2"
</pre>
<p>
teraz montujemy various bogus file systems:
</p>
<pre caption="Mount virtual file systems">
# mount -o bind /dev /mnt/gentoo32/dev
# mount -o bind /dev/pts /mnt/gentoo32/dev/pts
# mount -o bind /dev/shm /mnt/gentoo32/dev/shm
# mount -o bind /proc /mnt/gentoo32/proc
# mount -o bind /proc/bus/usb /mnt/gentoo32/proc/bus/usb
# mount -o bind /sys /mnt/gentoo32/sys
</pre>
<p>
Now you have a true 32bit chroot installed in your 64bits system which is almost ready for use. Next, you need to create a link from your portage available in your 64bit system to your chroot. This way, you only need to update it in one installation instead of duplicating a lot of data.
</p>
<pre caption="Link portage to /usr/portage inside the 32bits chroot">
# mkdir -p /mnt/gentoo32/usr/portage/
# mount -o bind /usr/portage /mnt/gentoo32/usr/portage/
</pre>
<note>Everytime you update your portage by doing a emerge sync, you update your 32bit chroot's portage as well.</note>
<p>
If you want to run 32bit applications which use X, you also need to mount /tmp.
</p>
<pre caption="Mount /tmp for applications with a GUI">
# mount -o bind /tmp /mnt/gentoo32/tmp
</pre>
<p>
Now we're ready to switch inside the chroot.
</p>
<pre caption="Changing inside the chroot">
<i>(Only perform this step if you don't have linux32 already installed)</i>
# emerge linux32
# linux32 chroot /mnt/gentoo32 /bin/bash
<i>(Make sure we have a i686 setup)</i>
# uname -m
Linux mysystem 2.6.12-gentoo-r1 #1 Mon Jun 27 02:41:55 GMT 2005 i686 AMD Athlon(tm) 64 Processor 3500+ AuthenticAMD GNU/Linux
</pre>
<warn>The <c>linux32</c> util is needed to change the CHOST value. If you forget it, you're likely to be unable to compile anything inside the chroot environment.</warn>
<p>
Now you have a new 32bits chroot system ready to be updated. Follow the next steps to update it.
</p>
<pre caption="Updating your new 32bits chroot">
# source /etc/profile
# env-update
# emerge -au world
</pre>
<p>
After this you basically have finished the setup of your 32bits chroot. To make things more suitable, we are going to set up a new file in your 64bit system to enable the 32bits chroot when booting.
</p>
<pre caption="creating a new file in /etc/init.d">
# nano -w /etc/init.d/gentoo32
#!/sbin/runscript

depend() {
   need localmount
   need bootmisc
}

start() {
    ebegin "Mounting 32bits chroot dirs"
    mount -o bind /dev /mnt/gentoo32/dev >/dev/null &amp;
    mount -o bind /dev/pts /mnt/gentoo32/dev/pts >/dev/null &amp;
    mount -o bind /dev/shm /mnt/gentoo32/dev/shm >/dev/null &amp;
    mount -o bind /proc /mnt/gentoo32/proc >/dev/null &amp;
    mount -o bind /proc/bus/usb /mnt/gentoo32/proc/bus/usb >/dev/null &amp;
    mount -o bind /sys /mnt/gentoo32/sys >/dev/null &amp;
    mount -o bind /tmp /mnt/gentoo32/tmp >/dev/null &amp;
    mount -o bind /usr/portage /mnt/gentoo32/usr/portage/ >/dev/null &amp;
    eend $? "An error occured while attempting to mount 32bit chroot directories"
    ebegin "Copying 32bits chroot files"
    cp -pf /etc/resolv.conf /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/passwd /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/shadow /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/group /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/gshadow /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/hosts /mnt/gentoo32/etc > /dev/null &amp;
    cp -Ppf /etc/localtime /mnt/gentoo32/etc >/dev/null &amp;
    eend $? "An error occured while attempting to copy 32 bits chroot files."
}

stop() {
    ebegin "Unmounting 32bits chroot dirs"
    umount -f /mnt/gentoo32/dev/pts >/dev/null &amp;
    umount -f /mnt/gentoo32/dev/shm >/dev/null &amp;
    umount -f /mnt/gentoo32/dev >/dev/null &amp;
    umount -f /mnt/gentoo32/proc/bus/usb >/dev/null &amp;
    umount -f /mnt/gentoo32/proc >/dev/null &amp;
    umount -f /mnt/gentoo32/sys >/dev/null &amp;
    umount -f /mnt/gentoo32/tmp >/dev/null &amp;
    umount -f /mnt/gentoo32/usr/portage/ >/dev/null &amp;
    eend $? "An error occured while attempting to unmount 32bits chroot directories"
}
</pre>
<p>
Now you only need to run <c>rc-update add gentoo32 default</c> to run it at boot time.
</p>
<p>
Whenever you want to switch to your chroot environment, you only need to run the following command: <c>linux32 chroot /mnt/gentoo32 /bin/bash</c>. 
</p>
<p>
Now you have your 32bit chroot ready to install new applications.
</p>
</body>
</subsection>
</section>

<section>
<title>Applications</title>
<subsection>
<title>Installing new applications in your chroot</title>
<body>
<p>
Now that you have a fully functional 32bits chroot you can install every application in 32bits mode. Let's see how you can install new packages on your 32bits chroot.
</p>
<pre caption="Install foo inside the chroot">
# linux32 chroot /mnt/gentoo32 /bin/bash
# source /etc/profile
# env-update
# emerge foo
</pre>
<note>Always remember to do <c>source /etc/profile</c> and <c>env-update</c> after switching inside the chroot.</note>
<p>
You now have installed a new package in your 32bit chroot. If you want to run your new package you need to run it inside of your chroot. If you want to run 
X applications the best solution to run it is doing the <c>xhost</c> trick. Everytime you need to run a X application run the this command in your 64bit environment:
</p>
<pre caption="Xhost trick">
# xhost local:localhost
</pre>
<p>
After this get inside your chroot again and you should be able to run every X application you build inside your 32bits chroot.
</p>
</body>
</subsection>
</section>

<section>
<title>Conclusion</title>
<subsection>
<title>Conclusion of this guide</title>
<body>
<p>
With this chroot you can install many packages available only for x86 arch. Some packages like <c>OpenOffice</c> can be installed by using the binary available for Gentoo/AMD64. Some of the codecs available for <c>MPlayer</c> need this 32bit chroot to so you can install <c>win32codecs</c> with this chroot.
</p>
</body>
</subsection>
</section>

</sections>
