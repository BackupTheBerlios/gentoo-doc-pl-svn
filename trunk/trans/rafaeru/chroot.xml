<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/pl/base/amd64/howtos/chroot.xml,v 1.5 2005/08/31 15:47:25 metalgod Exp $ -->

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->

<sections>

<version>1.0.2</version>
<date>2005-08-31</date>

<section>
<title>Wprowadzenie</title>
<subsection>
<title>Wprowadzenie do 64-bitowego systemu</title>
<body>
<p>
Przewodnik dla 32-bitowego chroot'a w Gentoo Linux pomaga ustawić prawdziwy 32-bitowy chroot na systemie Gentoo/AMD64. 
</p>
<p>
Jak wiemy systemy 64-bitowe nie obsługują jeszcze 32-bitowych aplikacji (przynajmniej nie z portage), więc będziemy musieli skożystać z bibliotek emulacji by zmusić je do działania, bądź też stworzyć prawdziwy 32-bitowy system wewnątrz chroot'a, by zainstalować i uruchamiać 32-bitowe aplikacje. Dla zwykłych potrzeb nie musimy budować prawdziwego 32-bitowego systemu wewnątrz chroot'a. Jednakże, jeżeli chcemy uruchamiać aplikacje, które nie posiadają binariów umozliwiających pracę z 32-bitowymi bibliotekami, musimy skożystać 32-bitowego chroot'a. Przewodnik ten uczy jak utworzyć 32-bitowy chroot oraz jak zainstalować i uruchamiać w nim aplikacje.
</p>
</body>
</subsection>
</section>

<section>
<title>Instalacja</title>
<subsection>
<title>Instalacja 32-bitowego chroot'a</title>
<body>
<p>
By zainstalować 32-bitowy chroot podążamy radami jakimi kierujemy się podczas instalacji Gentoo Linux na systemie x86. W tej chwili potrzebujemy najnowszego stage3, dostępnego w <uri link="http://www.gentoo.org/main/en/mirrors.xml">Gentoo mirrors</uri>.
</p>
<pre caption="ściąganie stage3 z gentoo mirrors">
$ cd /home/user/downloads
$ wget -c http://distfiles.gentoo.org/releases/x86/2005.0/stages/athlon-xp/stage3-athlon-xp-2005.0.tar.bz2
</pre>
<note>Należy zwrócić uwagę, iż ściągamy wersję stage dla x86, <c>nie</c> dla AMD64.</note>
<p>
Po ukończeniu ściągania musimy stworzyć miejsce dla nowego chroot'a.
</p>
<pre caption="tworzenie katalogu dla 32-bitowego chroot'a">
$ su root <i>wprowadzamy hasło root'a</i>
# cd /mnt
# mkdir gentoo32
</pre>
<p>
Następnie przenosimy ściągnięty stage, rozpakowujemy i instalujemy go według przykładu.
</p>
<pre caption="instalacja ze stage3">
# cd /mnt/gentoo32
# tar -xvjpf /home/user/downloads/stage3-athlon-xp-2005.0.tar.bz2
# cp -L /etc/resolv.conf /mnt/gentoo32/etc/
# cp -L /etc/passwd /mnt/gentoo32/etc/
</pre>
<p>
W tej chwili mamy gotowy do tworzenia chroot. Kolejny rozdział pokazuje jak to się odbywa.
</p>
</body>
</subsection>
</section>

<section>
<title>Tworzenie</title>
<subsection>
<title>Tworzenie 32-bitowego chroot'a</title>
<body>
<p>
Jeżeli nie napotkaliśmy żadnych błędów, możemy śmiało rozpocząć tworzenie i sfinalizować instalację 32-bitowego chroot'a.
</p>
<p>
Kolejnym krokiem jest utworzenie nowego <c>/mnt/gentoo32/etc/make.conf</c>.
</p>
<pre caption="Konfiguracja nowego make.conf">
CFLAGS="-O2 -march=athlon-xp -msse2 -pipe -fomit-frame-pointer"
CHOST="i686-pc-linux-gnu"
CXXFLAGS="${CFLAGS}"
MAKEOPTS="-j2"
</pre>
<p>
Teraz montujemy różne fikcyjne systemy plików:
</p>
<pre caption="Montujemy wirtualne systemy plików">
# mount -o bind /dev /mnt/gentoo32/dev
# mount -o bind /dev/pts /mnt/gentoo32/dev/pts
# mount -o bind /dev/shm /mnt/gentoo32/dev/shm
# mount -o bind /proc /mnt/gentoo32/proc
# mount -o bind /proc/bus/usb /mnt/gentoo32/proc/bus/usb
# mount -o bind /sys /mnt/gentoo32/sys
</pre>
<p>
W tym momencie mamy prawdziwy 32-bitowy chroot zainstalowany na 64-bitowym systemie, który jest już praktycznie gotowy do użycia. Następnie musimy stworzyć link z portage dostępnego w 64-bitowym systemie do chroot'a. Dzieki temu można wykonać update w jednej instalacji dla obydwu systemów zamiast kopiować wiele danych.
</p>
<pre caption="Łączymy portage z /usr/portage wewnątrz 32-bitowego chroot'a">
# mkdir -p /mnt/gentoo32/usr/portage/
# mount -o bind /usr/portage /mnt/gentoo32/usr/portage/
</pre>
<note>Za każdym razem gdy wykonamy update portage poleceniem emerge sync, zupdatujemy również portage 32-bitowego chroota'a.</note>
<p>
Jeżeli chcemy uruchomić 32-bitowe aplikacje wymagające X, musimy zamontować /tmp.
</p>
<pre caption="Montujemy /tmp dla aplikacji posiadających GUI">
# mount -o bind /tmp /mnt/gentoo32/tmp
</pre>
<p>
Teraz możemy przejść do wnętrza chroot'a.
</p>
<pre caption="Przechodzimy do środowiska utworzonego chroot'a">
<i>(Krok ten wykonujemy tylko i wyłącznie wtedy, gdy nie mamy zainstalowanego linux32)</i>
# emerge linux32
# linux32 chroot /mnt/gentoo32 /bin/bash
<i>(Upewaniamy się czy nasza konfiguracja to i686)</i>
# uname -m
Linux mysystem 2.6.12-gentoo-r1 #1 Mon Jun 27 02:41:55 GMT 2005 i686 AMD Athlon(tm) 64 Processor 3500+ AuthenticAMD GNU/Linux
</pre>
<warn>Narzędzie <c>linux32</c> jest potrzebne do zmiany wartości CHOST. Jeżeli je pominiemy, nie będzie możliwa kompilacja wewnątrz chroot'a.</warn>
<p>
W tej chwili mamy w swoich rękach 32-bitowy chroot gotowy do aktualizacji. Kolejne kroki przeprowadzą nas przez update.
</p>
<pre caption="Update nowego, 32-bitowego chroot'a">
# source /etc/profile
# env-update
# emerge -au world
</pre>
<p>
Po tej czynności mamy praktycznie gotowy 32-bitowy chroot. By dopasować wszystkie opcje, utworzymy nowy plik w 64-bitowym systemie, by udostępnić 32-bitowy chroot podczas uruchamiania systemu.
</p>
<pre caption="Tworzymy nowy plik w /etc/init.d">
# nano -w /etc/init.d/gentoo32
#!/sbin/runscript

depend() {
   need localmount
   need bootmisc
}

start() {
    ebegin "Mounting 32bits chroot dirs"
    mount -o bind /dev /mnt/gentoo32/dev >/dev/null &amp;
    mount -o bind /dev/pts /mnt/gentoo32/dev/pts >/dev/null &amp;
    mount -o bind /dev/shm /mnt/gentoo32/dev/shm >/dev/null &amp;
    mount -o bind /proc /mnt/gentoo32/proc >/dev/null &amp;
    mount -o bind /proc/bus/usb /mnt/gentoo32/proc/bus/usb >/dev/null &amp;
    mount -o bind /sys /mnt/gentoo32/sys >/dev/null &amp;
    mount -o bind /tmp /mnt/gentoo32/tmp >/dev/null &amp;
    mount -o bind /usr/portage /mnt/gentoo32/usr/portage/ >/dev/null &amp;
    eend $? "An error occured while attempting to mount 32bit chroot directories"
    ebegin "Copying 32bits chroot files"
    cp -pf /etc/resolv.conf /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/passwd /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/shadow /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/group /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/gshadow /mnt/gentoo32/etc >/dev/null &amp;
    cp -pf /etc/hosts /mnt/gentoo32/etc > /dev/null &amp;
    cp -Ppf /etc/localtime /mnt/gentoo32/etc >/dev/null &amp;
    eend $? "An error occured while attempting to copy 32 bits chroot files."
}

stop() {
    ebegin "Unmounting 32bits chroot dirs"
    umount -f /mnt/gentoo32/dev/pts >/dev/null &amp;
    umount -f /mnt/gentoo32/dev/shm >/dev/null &amp;
    umount -f /mnt/gentoo32/dev >/dev/null &amp;
    umount -f /mnt/gentoo32/proc/bus/usb >/dev/null &amp;
    umount -f /mnt/gentoo32/proc >/dev/null &amp;
    umount -f /mnt/gentoo32/sys >/dev/null &amp;
    umount -f /mnt/gentoo32/tmp >/dev/null &amp;
    umount -f /mnt/gentoo32/usr/portage/ >/dev/null &amp;
    eend $? "An error occured while attempting to unmount 32bits chroot directories"
}
</pre>
<p>
Teraz wystarczy uruchomić <c>rc-update add gentoo32 default</c> by chroot odpalał się przy starcie.
</p>
<p>
Jeżeli zechcemy przełączyć się do środowiska chroot, wystarczy skożystać z następującej komendy: <c>linux32 chroot /mnt/gentoo32 /bin/bash</c>. 
</p>
<p>
Nasz 32-bitowy chroot jest w tej chwili przygotowany do instalacji nowych aplikacji.
</p>
</body>
</subsection>
</section>

<section>
<title>Aplikacje</title>
<subsection>
<title>Instalowanie nowych aplikacji w chroot'cie</title>
<body>
<p>
Teraz, kiedy mamy w pełni funkcjonalny 32-bitowy chroot, możemy zainstalować każdą 32-bitową aplikację. Sprawdźmy jak przebiega instalacja nowych pakietów.
</p>
<pre caption="Instalujemy foo wewnątrz chroot'a">
# linux32 chroot /mnt/gentoo32 /bin/bash
# source /etc/profile
# env-update
# emerge foo
</pre>
<note>Należy pamietać o wykonaniu <c>source /etc/profile</c> oraz <c>env-update</c> po przełączeniu się na chroot'a.</note>
<p>
Zainstalowaliśmy nowy pakiet na 32-bitowym chroot'cie. Jeżeli chcemy go uruchomić, musimy zainicjować go wewnątrz chroot'a. Jeżeli chcemy uruchomić aplikację korzystającą z X, najlepszym rozwiązaniem jest <c>xhost</c>. Za każdym razem gdy chcemy uruchomić aplikację wykorzystującą X, wykonujemy następujące polecenie w naszym 64-bitowym systemie:
</p>
<pre caption="Xhost">
# xhost local:localhost
</pre>
<p>
Po tym przechodzimy spowrotem do chroot'a i możemy uruchamiać każdą aplikację wymagającą X, wcześniej skompilowaną wewnątrz chroot'a.
</p>
</body>
</subsection>
</section>

<section>
<title>Podsumowanie</title>
<subsection>
<title>Podsumowanie poradnika</title>
<body>
<p>
Dzięki chroot'owi możemy instalować wiele pakietów normalnie dostępnych tylko dla systemów x86. Niektóre pakiety takie jak <c>OpenOffice</c> mogą zostać zainstalowane przy pomocy binariów dostępnych dla Gentoo/AMD64. Niektóre z kodeków dostępnych dla programu <c>MPlayer</c> również wymagają 32-bitowego chroota, więc umożliwia on instalację pakietu <c>win32codecs</c>.
</p>
</body>
</subsection>
</section>

</sections>
